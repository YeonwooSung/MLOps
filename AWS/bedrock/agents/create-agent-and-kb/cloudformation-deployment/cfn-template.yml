Parameters:
  S3BucketNameWithAssets:
    Type: String
    Description: Bucket name where you uploaded assets folder.
  AgentName:
    Type: String
    Default: cfn-agent-kb
    Description: Name of the agent to be created.
Resources:
  agent406artifactsBucket26949708:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Join
        - '-'
        - - 'artifacts'
          - !Ref S3BucketNameWithAssets
          - '406'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: aws-cdk:auto-delete-objects
          Value: "true"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  agent406artifactsBucketPolicy8A4A2660:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: agent406artifactsBucket26949708
      PolicyDocument:
        Statement:
          - Action: s3:*
            Condition:
              Bool:
                aws:SecureTransport: "false"
            Effect: Deny
            Principal:
              AWS: "*"
            Resource:
              - Fn::GetAtt:
                  - agent406artifactsBucket26949708
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - agent406artifactsBucket26949708
                        - Arn
                    - /*
          - Action:
              - s3:DeleteObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
                  - Arn
            Resource:
              - Fn::GetAtt:
                  - agent406artifactsBucket26949708
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - agent406artifactsBucket26949708
                        - Arn
                    - /*
        Version: "2012-10-17"
  agent406artifactsBucketAutoDeleteObjectsCustomResource2AC7BA5B:
    Type: Custom::S3AutoDeleteObjects
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F
          - Arn
      BucketName:
        Ref: agent406artifactsBucket26949708
    DependsOn:
      - agent406artifactsBucketPolicy8A4A2660
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
      ManagedPolicyArns:
        - Fn::Sub: arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/custom-resources/custom-s3-autodelete.zip
      Timeout: 900
      MemorySize: 128
      Handler: custom-s3-autodelete/index.handler
      Role:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
          - Arn
      Runtime: nodejs18.x
      Description:
        Fn::Join:
          - ""
          - - "Lambda function for auto-deleting objects in "
            - Ref: agent406artifactsBucket26949708
            - " S3 bucket."
    DependsOn:
      - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
    Metadata:
      aws:asset:path: asset.d28a3fa64d0bd6c7c6f1d6fd707d3e6dc5c81fe8f47891b89459b6492586997f
      aws:asset:property: Code
  agent406knowledgebaseBucketEC2EE27E:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Join 
        - '-'
        - - 'knowledgebase'
          - !Ref S3BucketNameWithAssets
          - '406'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: aws-cdk:auto-delete-objects
          Value: "true"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  agent406knowledgebaseBucketPolicyA3DFF6F9:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: agent406knowledgebaseBucketEC2EE27E
      PolicyDocument:
        Statement:
          - Action: s3:*
            Condition:
              Bool:
                aws:SecureTransport: "false"
            Effect: Deny
            Principal:
              AWS: "*"
            Resource:
              - Fn::GetAtt:
                  - agent406knowledgebaseBucketEC2EE27E
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - agent406knowledgebaseBucketEC2EE27E
                        - Arn
                    - /*
          - Action:
              - s3:DeleteObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
                  - Arn
            Resource:
              - Fn::GetAtt:
                  - agent406knowledgebaseBucketEC2EE27E
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - agent406knowledgebaseBucketEC2EE27E
                        - Arn
                    - /*
        Version: "2012-10-17"
  agent406knowledgebaseBucketAutoDeleteObjectsCustomResourceEE7C8730:
    Type: Custom::S3AutoDeleteObjects
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F
          - Arn
      BucketName:
        Ref: agent406knowledgebaseBucketEC2EE27E
    DependsOn:
      - agent406knowledgebaseBucketPolicyA3DFF6F9
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  openapi406BucketB3EA5C77:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Join
        - '-'
        - - 'openapi'
          - !Ref S3BucketNameWithAssets
          - '406'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: aws-cdk:auto-delete-objects
          Value: "true"
        - Key: aws-cdk:cr-owned:api-schemas:f7a33beb
          Value: "true"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  openapi406BucketPolicy3462A569:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: openapi406BucketB3EA5C77
      PolicyDocument:
        Statement:
          - Action: s3:*
            Condition:
              Bool:
                aws:SecureTransport: "false"
            Effect: Deny
            Principal:
              AWS: "*"
            Resource:
              - Fn::GetAtt:
                  - openapi406BucketB3EA5C77
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - openapi406BucketB3EA5C77
                        - Arn
                    - /*
          - Action:
              - s3:DeleteObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
                  - Arn
            Resource:
              - Fn::GetAtt:
                  - openapi406BucketB3EA5C77
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - openapi406BucketB3EA5C77
                        - Arn
                    - /*
        Version: "2012-10-17"
  openapi406BucketAutoDeleteObjectsCustomResource133D5CD5:
    Type: Custom::S3AutoDeleteObjects
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F
          - Arn
      BucketName:
        Ref: openapi406BucketB3EA5C77
    DependsOn:
      - openapi406BucketPolicy3462A569
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  openapi406ApiSchemasBucketAwsCliLayer0954860A:
    Type: AWS::Lambda::LayerVersion
    Properties:
      Content:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/custom-resources/awscli.zip
      Description: /opt/awscli/aws
    Metadata:
      aws:asset:path: asset.3fb6287214999ddeafa7cd0e3e58bc5144c8678bb720f3b5e45e8fd32f333eb3.zip
      aws:asset:is-bundled: false
      aws:asset:property: Content
  openapi406ApiSchemasBucketCustomResource3B827234:
    Type: Custom::CDKBucketDeployment
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536
          - Arn
      SourceBucketNames:
        - Ref: S3BucketNameWithAssets
      SourceObjectKeys:
        - assets/openapi-schemas.zip
      DestinationBucketName:
        Ref: openapi406BucketB3EA5C77
      DestinationBucketKeyPrefix: api-schemas
      Prune: true
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetBucket*
              - s3:GetObject*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: S3BucketNameWithAssets
                    - /*
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: S3BucketNameWithAssets
          - Action:
              - s3:Abort*
              - s3:DeleteObject*
              - s3:GetBucket*
              - s3:GetObject*
              - s3:List*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - openapi406BucketB3EA5C77
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - openapi406BucketB3EA5C77
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF
      Roles:
        - Ref: CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265
  CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/custom-resources/custom-cdk-bucket-deployment.zip
      Role:
        Fn::GetAtt:
          - CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265
          - Arn
      Environment:
        Variables:
          AWS_CA_BUNDLE: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
      Handler: index.handler
      Layers:
        - Ref: openapi406ApiSchemasBucketAwsCliLayer0954860A
      Runtime: python3.9
      Timeout: 900
    DependsOn:
      - CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF
      - CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265
    Metadata:
      aws:asset:path: asset.9eb41a5505d37607ac419321497a4f8c21cf0ee1f9b4a6b29aa04301aea5c7fd
      aws:asset:is-bundled: false
      aws:asset:property: Code
  lambdalayerconstruct406BedrockAgentLayerA13086E3:
    Type: AWS::Lambda::LayerVersion
    Properties:
      Content:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/agents-layer.zip
      CompatibleRuntimes:
        - python3.10
    Metadata:
      aws:asset:path: asset.269e0f32563731540aa578d3dd01a2c3249d5fdc29abc193bbfd496a444fa367.zip
      aws:asset:is-bundled: false
      aws:asset:property: Content
  CreateAgentLambdaIamConstruct406CreateAgentLambdaRole397384AA:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/CloudWatchLogsFullAccess
      RoleName: bedrock-agent-lambda-role-406
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateAgentLambdaIamConstruct406lambdaAllowPolicy440B9E73:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - lambda:AddPermission
              - lambda:CreateFunction
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CreateAgentLambdaAllowPolicy-406
      Roles:
        - Ref: CreateAgentLambdaIamConstruct406CreateAgentLambdaRole397384AA
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateAgentLambdaIamConstruct406iamCreateAgentAllowPolicy1E00EAF8:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - iam:AttachRolePolicy
              - iam:CreatePolicy
              - iam:CreateRole
              - iam:GetRole
              - iam:PassRole
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CreateAgentIamAllowPolicy-406
      Roles:
        - Ref: CreateAgentLambdaIamConstruct406CreateAgentLambdaRole397384AA
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateAgentLambdaIamConstruct406s3CreateAgentAllowPolicy60D647A7:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:ListBucket
              - s3:PutObject
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - agent406artifactsBucket26949708
                  - Arn
              - Fn::GetAtt:
                  - agent406knowledgebaseBucketEC2EE27E
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - agent406artifactsBucket26949708
                        - Arn
                    - /*
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - agent406knowledgebaseBucketEC2EE27E
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CreateAgentS3AllowPolicy-406
      Roles:
        - Ref: CreateAgentLambdaIamConstruct406CreateAgentLambdaRole397384AA
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateAgentLambdaIamConstruct406bedrockCreateAgentAllowPolicy9CE6AC34:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: bedrock:*
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CreateAgentBedrockAllowPolicy-406
      Roles:
        - Ref: CreateAgentLambdaIamConstruct406CreateAgentLambdaRole397384AA
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateKbLambdaIamConstructkb406CreateKbLambdaRoleA446172F:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/CloudWatchLogsFullAccess
      RoleName: bedrock-kb-lambda-role-406
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateKbLambdaIamConstructkb406lambdaAllowPolicyE77D6585:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:GetFunctionConfiguration
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CreateKbLambdaAllowPolicy-406
      Roles:
        - Ref: CreateKbLambdaIamConstructkb406CreateKbLambdaRoleA446172F
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateKbLambdaIamConstructkb406CreateKbiamAllowPolicyAEBF5F91:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - iam:AttachRolePolicy
              - iam:CreatePolicy
              - iam:CreateRole
              - iam:GetRole
              - iam:PassRole
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CreateKbIamAllowPolicy-406
      Roles:
        - Ref: CreateKbLambdaIamConstructkb406CreateKbLambdaRoleA446172F
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateKbLambdaIamConstructkb406bedrockAllowPolicyEF7BFD4D:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: bedrock:*
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CreateKbBedrockAllowPolicy-406
      Roles:
        - Ref: CreateKbLambdaIamConstructkb406CreateKbLambdaRoleA446172F
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  CreateKbLambdaIamConstructkb406opensearchAllowPolicy4E0BDF0D:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - aoss:APIAccessAll
              - aoss:BatchGetCollection
              - aoss:CreateAccessPolicy
              - aoss:CreateCollection
              - aoss:CreateDomain
              - aoss:CreateSecurityPolicy
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CreateKbOpensearchAllowPolicy-406
      Roles:
        - Ref: CreateKbLambdaIamConstructkb406CreateKbLambdaRoleA446172F
    DependsOn:
      - openapi406ApiSchemasBucketAwsCliLayer0954860A
      - openapi406ApiSchemasBucketCustomResource3B827234
      - openapi406BucketAutoDeleteObjectsCustomResource133D5CD5
      - openapi406BucketPolicy3462A569
      - openapi406BucketB3EA5C77
  LambdaAgentConstruct406BedrockAgentLambda62EB6542:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/lambda-function-create-agent.zip
      Role:
        Fn::GetAtt:
          - CreateAgentLambdaIamConstruct406CreateAgentLambdaRole397384AA
          - Arn
      Architectures:
        - x86_64
      FunctionName: bedrock-agent-lambda-406
      Handler: lambda-function-create-agent/create_agent.lambda_handler
      Layers:
        - Ref: lambdalayerconstruct406BedrockAgentLayerA13086E3
      Runtime: python3.10
      Timeout: 600
    DependsOn:
      - CreateAgentLambdaIamConstruct406bedrockCreateAgentAllowPolicy9CE6AC34
      - CreateAgentLambdaIamConstruct406CreateAgentLambdaRole397384AA
      - CreateAgentLambdaIamConstruct406iamCreateAgentAllowPolicy1E00EAF8
      - CreateAgentLambdaIamConstruct406lambdaAllowPolicy440B9E73
      - CreateAgentLambdaIamConstruct406s3CreateAgentAllowPolicy60D647A7
      - lambdalayerconstruct406BedrockAgentLayerA13086E3
    Metadata:
      aws:asset:path: asset.547b06086d68f950d115e251b0f3724f8135ddba9b5742cbeb695ef353d4eba9
      aws:asset:is-bundled: false
      aws:asset:property: Code
  LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - LambdaAgentConstruct406BedrockAgentLambda62EB6542
          - Arn
      Principal: bedrock.amazonaws.com
    DependsOn:
      - CreateAgentLambdaIamConstruct406bedrockCreateAgentAllowPolicy9CE6AC34
      - CreateAgentLambdaIamConstruct406CreateAgentLambdaRole397384AA
      - CreateAgentLambdaIamConstruct406iamCreateAgentAllowPolicy1E00EAF8
      - CreateAgentLambdaIamConstruct406lambdaAllowPolicy440B9E73
      - CreateAgentLambdaIamConstruct406s3CreateAgentAllowPolicy60D647A7
      - lambdalayerconstruct406BedrockAgentLayerA13086E3
  LambdaKbConstruct406BedrockAgentLambdaA2989B12:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/lambda-function-create-kb.zip
      Role:
        Fn::GetAtt:
          - CreateKbLambdaIamConstructkb406CreateKbLambdaRoleA446172F
          - Arn
      Architectures:
        - x86_64
      FunctionName: bedrock-kb-lambda-406
      Handler: lambda-function-create-kb/create_knowledge_base.lambda_handler
      Layers:
        - Ref: lambdalayerconstruct406BedrockAgentLayerA13086E3
      Runtime: python3.10
      Timeout: 600
    DependsOn:
      - CreateKbLambdaIamConstructkb406bedrockAllowPolicyEF7BFD4D
      - CreateKbLambdaIamConstructkb406CreateKbiamAllowPolicyAEBF5F91
      - CreateKbLambdaIamConstructkb406CreateKbLambdaRoleA446172F
      - CreateKbLambdaIamConstructkb406lambdaAllowPolicyE77D6585
      - CreateKbLambdaIamConstructkb406opensearchAllowPolicy4E0BDF0D
      - lambdalayerconstruct406BedrockAgentLayerA13086E3
    Metadata:
      aws:asset:path: asset.16cae7f7331369fd8fd692790a1f69619f47e98501ff2eefefae21c6a09f31be
      aws:asset:is-bundled: false
      aws:asset:property: Code
  LambdaKbConstruct406BedrockAgentLambdaInvoke1fBIBwkGKTIwSRmFV8O1yjU9AKdA1Znl7HToNrxfA4853BB43:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - LambdaKbConstruct406BedrockAgentLambdaA2989B12
          - Arn
      Principal: events.amazonaws.com
    DependsOn:
      - CreateKbLambdaIamConstructkb406bedrockAllowPolicyEF7BFD4D
      - CreateKbLambdaIamConstructkb406CreateKbiamAllowPolicyAEBF5F91
      - CreateKbLambdaIamConstructkb406CreateKbLambdaRoleA446172F
      - CreateKbLambdaIamConstructkb406lambdaAllowPolicyE77D6585
      - CreateKbLambdaIamConstructkb406opensearchAllowPolicy4E0BDF0D
      - lambdalayerconstruct406BedrockAgentLayerA13086E3
  eventbridgeconstruct406BedrockKbEventBusA93A7A8C:
    Type: AWS::Events::EventBus
    Properties:
      Name: BedrockKbEventBus
    DependsOn:
      - LambdaKbConstruct406BedrockAgentLambdaInvoke1fBIBwkGKTIwSRmFV8O1yjU9AKdA1Znl7HToNrxfA4853BB43
      - LambdaKbConstruct406BedrockAgentLambdaA2989B12
  eventbridgeconstruct406CreateKbEventRuleB48AE704:
    Type: AWS::Events::Rule
    Properties:
      Description: Rule to invoke Lambda function that creates KB from event sent by agent through another Lambda.
      EventBusName:
        Ref: eventbridgeconstruct406BedrockKbEventBusA93A7A8C
      EventPattern:
        source:
          - create-kb.event
      Name: CreateKbEventRule
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - LambdaKbConstruct406BedrockAgentLambdaA2989B12
              - Arn
          Id: Target0
    DependsOn:
      - LambdaKbConstruct406BedrockAgentLambdaInvoke1fBIBwkGKTIwSRmFV8O1yjU9AKdA1Znl7HToNrxfA4853BB43
      - LambdaKbConstruct406BedrockAgentLambdaA2989B12
  eventbridgeconstruct406CreateKbEventRuleAllowEventRuleBedrockAgentCdkStackLambdaKbConstruct406BedrockAgentLambdaB675180784D66B34:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - LambdaKbConstruct406BedrockAgentLambdaA2989B12
          - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - eventbridgeconstruct406CreateKbEventRuleB48AE704
          - Arn
    DependsOn:
      - LambdaKbConstruct406BedrockAgentLambdaInvoke1fBIBwkGKTIwSRmFV8O1yjU9AKdA1Znl7HToNrxfA4853BB43
      - LambdaKbConstruct406BedrockAgentLambdaA2989B12
  InvokeKbLambdaIamConstructkb406InvokeCreateKbLambdaRole4EE77610:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/CloudWatchLogsFullAccess
      RoleName: bedrock-invoke-lambda-role-406
    DependsOn:
      - eventbridgeconstruct406BedrockKbEventBusA93A7A8C
      - eventbridgeconstruct406CreateKbEventRuleAllowEventRuleBedrockAgentCdkStackLambdaKbConstruct406BedrockAgentLambdaB675180784D66B34
      - eventbridgeconstruct406CreateKbEventRuleB48AE704
  InvokeKbLambdaIamConstructkb406EventBusAllowPolicy03EC24EC:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: events:PutEvents
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - eventbridgeconstruct406BedrockKbEventBusA93A7A8C
                - Arn
        Version: "2012-10-17"
      PolicyName: InvokeCreateKbEventBusAllowPolicy-406
      Roles:
        - Ref: InvokeKbLambdaIamConstructkb406InvokeCreateKbLambdaRole4EE77610
    DependsOn:
      - eventbridgeconstruct406BedrockKbEventBusA93A7A8C
      - eventbridgeconstruct406CreateKbEventRuleAllowEventRuleBedrockAgentCdkStackLambdaKbConstruct406BedrockAgentLambdaB675180784D66B34
      - eventbridgeconstruct406CreateKbEventRuleB48AE704
  LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/lambda-function-invoke-create-kb.zip
      Role:
        Fn::GetAtt:
          - InvokeKbLambdaIamConstructkb406InvokeCreateKbLambdaRole4EE77610
          - Arn
      Architectures:
        - x86_64
      FunctionName: invoke-kb-lambda-406
      Handler: lambda-function-invoke-create-kb/invoke_create_knowledge_base_lambda.lambda_handler
      Layers:
        - Ref: lambdalayerconstruct406BedrockAgentLayerA13086E3
      Runtime: python3.10
      Timeout: 900
    DependsOn:
      - InvokeKbLambdaIamConstructkb406EventBusAllowPolicy03EC24EC
      - InvokeKbLambdaIamConstructkb406InvokeCreateKbLambdaRole4EE77610
    Metadata:
      aws:asset:path: asset.39d66fbb9d3fa6fb8316e2b1dff8ff9b3b77e1538dc98b4592c1839ded1c4ff8
      aws:asset:is-bundled: false
      aws:asset:property: Code
  LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
          - Arn
      Principal: bedrock.amazonaws.com
    DependsOn:
      - InvokeKbLambdaIamConstructkb406EventBusAllowPolicy03EC24EC
      - InvokeKbLambdaIamConstructkb406InvokeCreateKbLambdaRole4EE77610
  BedrockIamConstruct406BedrockAgentRoleA87DEEA4:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
        Version: "2012-10-17"
      RoleName: AmazonBedrockExecutionRoleForAgents_406
    DependsOn:
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  BedrockIamConstruct406BedrockAgentLambdaPolicy57174647:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - LambdaAgentConstruct406BedrockAgentLambda62EB6542
                  - Arn
              - Fn::GetAtt:
                  - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
                  - Arn
        Version: "2012-10-17"
      PolicyName: BedrockAgentLambdaPolicy-406
      Roles:
        - Ref: BedrockIamConstruct406BedrockAgentRoleA87DEEA4
    DependsOn:
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: s3:GetObject
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - openapi406BucketB3EA5C77
                        - Arn
                    - /api-schemas/create-agent-schema.json
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - openapi406BucketB3EA5C77
                        - Arn
                    - /api-schemas/invoke-create-kb-lambda-schema.json
        Version: "2012-10-17"
      PolicyName: BedrockAgentS3BucketPolicy-406
      Roles:
        - Ref: BedrockIamConstruct406BedrockAgentRoleA87DEEA4
    DependsOn:
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: bedrock:*
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: BedrockAgentBedrockModelPolicy-406
      Roles:
        - Ref: BedrockIamConstruct406BedrockAgentRoleA87DEEA4
    DependsOn:
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  custombedrockagentconstruct406bedrockAgentCustomResourceRole0564105B:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
    DependsOn:
      - BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354
      - BedrockIamConstruct406BedrockAgentLambdaPolicy57174647
      - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
      - BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  custombedrockagentconstruct406bedrockAgentCustomResourceRoleDefaultPolicy72409268:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: "*"
            Effect: Allow
            Resource:
              - arn:aws:bedrock:*
              - Fn::GetAtt:
                  - openapi406BucketB3EA5C77
                  - Arn
              - Fn::Join:
                  - ""
                  - - "arn:aws:iam::"
                    - Ref: AWS::AccountId
                    - :role/AmazonBedrockExecutionRoleForAgents_406
        Version: "2012-10-17"
      PolicyName: custombedrockagentconstruct406bedrockAgentCustomResourceRoleDefaultPolicy72409268
      Roles:
        - Ref: custombedrockagentconstruct406bedrockAgentCustomResourceRole0564105B
    DependsOn:
      - BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354
      - BedrockIamConstruct406BedrockAgentLambdaPolicy57174647
      - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
      - BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  custombedrockagentconstruct406BedrockAgentCustomResourceFunctionF89C3980:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/custom-resource.zip
      Role:
        Fn::GetAtt:
          - custombedrockagentconstruct406bedrockAgentCustomResourceRole0564105B
          - Arn
      Architectures:
        - x86_64
      Environment:
        Variables:
          RESOURCE_ID: BEDROCK_AGENT_CUSTOM_RESOURCE
          S3_BUCKET:
            Ref: openapi406BucketB3EA5C77
          S3_BUCKET_CREATE_AGENT_KEY: api-schemas/create-agent-schema.json
          S3_BUCKET_CREATE_KB_KEY: api-schemas/invoke-create-kb-lambda-schema.json
          AGENT_NAME:
            Ref: AgentName
          BEDROCK_AGENT_ROLE_ARN:
            Fn::GetAtt:
              - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
              - Arn
          BEDROCK_CREATE_AGENT_LAMBDA_ARN:
            Fn::GetAtt:
              - LambdaAgentConstruct406BedrockAgentLambda62EB6542
              - Arn
          BEDROCK_INVOKE_CREATE_KB_LAMBDA_ARN:
            Fn::GetAtt:
              - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
              - Arn
          MODEL_NAME: anthropic.claude-v2
          INSTRUCTION: |
            You are an assistant for solution architects (SA) to create code for Agents for Amazon Bedrock.
            When creating an agent, consider the following: 1. The user may tell you where to save the artifacts, and they may not tell you that it is an s3 bucket. 
            Assume that the destination they provide is indeed the name of the s3 bucket. If they provide the bucket name, use it instead of prompting them for the bucket name.
            2. The user may describe an entire list of actions or api's 3.
            They may refer to the api in various terms like method, function, tool, action
            4. Feel free to come up with an agent name based on the description when returning results of creation of an agent but always keep it under 20 characters long. 
            After you create an agent and return the response from "Create-Agent", ask user if they want to create a knowledge base and associate it to the newly created agent. If the user answers affirmative, inquire for S3 bucket name with files. 
            Don't create random S3 bucket name. Once they do, use "Create-Knowledge-Base" action group and create a knowledge base. 
            If the answer is negative, i.e. they said "no" or similar to the knowledge base creation request - do not do anything.
      Handler: custom-resource/bedrock_agent_custom_resource.on_event
      Layers:
        - Ref: lambdalayerconstruct406BedrockAgentLayerA13086E3
      Runtime: python3.10
      Timeout: 600
    DependsOn:
      - BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354
      - BedrockIamConstruct406BedrockAgentLambdaPolicy57174647
      - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
      - BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC
      - custombedrockagentconstruct406bedrockAgentCustomResourceRoleDefaultPolicy72409268
      - custombedrockagentconstruct406bedrockAgentCustomResourceRole0564105B
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
    Metadata:
      aws:asset:path: asset.2cb620df99fe16b7c78b1d60a37b76ebb61f739e62b7b747746912dfba92e67c
      aws:asset:is-bundled: false
      aws:asset:property: Code
  custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEventServiceRoleF7D6D3FB:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    DependsOn:
      - BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354
      - BedrockIamConstruct406BedrockAgentLambdaPolicy57174647
      - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
      - BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEventServiceRoleDefaultPolicy84472F12:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - custombedrockagentconstruct406BedrockAgentCustomResourceFunctionF89C3980
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - custombedrockagentconstruct406BedrockAgentCustomResourceFunctionF89C3980
                        - Arn
                    - :*
        Version: "2012-10-17"
      PolicyName: custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEventServiceRoleDefaultPolicy84472F12
      Roles:
        - Ref: custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEventServiceRoleF7D6D3FB
    DependsOn:
      - BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354
      - BedrockIamConstruct406BedrockAgentLambdaPolicy57174647
      - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
      - BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEvent38B28A5F:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/custom-resources/bedrock-agent-custom-resource.zip
      Role:
        Fn::GetAtt:
          - custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEventServiceRoleF7D6D3FB
          - Arn
      Description: AWS CDK resource provider framework - onEvent (BedrockAgentCdkStack/custom-bedrock-agent-construct-406/BedrockCustomResourceProvider)
      Environment:
        Variables:
          USER_ON_EVENT_FUNCTION_ARN:
            Fn::GetAtt:
              - custombedrockagentconstruct406BedrockAgentCustomResourceFunctionF89C3980
              - Arn
      Handler: bedrock-agent-custom-resource/framework.onEvent
      Runtime: nodejs18.x
      Timeout: 900
    DependsOn:
      - BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354
      - BedrockIamConstruct406BedrockAgentLambdaPolicy57174647
      - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
      - BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC
      - custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEventServiceRoleDefaultPolicy84472F12
      - custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEventServiceRoleF7D6D3FB
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
    Metadata:
      aws:asset:path: asset.f2d30cfc360482320a52a4fcde8a70f3569df79ab30be24650fda58eb60052cf
      aws:asset:is-bundled: false
      aws:asset:property: Code
  custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEventLogRetention11357A12:
    Type: Custom::LogRetention
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A
          - Arn
      LogGroupName:
        Fn::Join:
          - ""
          - - /aws/lambda/
            - Ref: custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEvent38B28A5F
      RetentionInDays: 1
    DependsOn:
      - BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354
      - BedrockIamConstruct406BedrockAgentLambdaPolicy57174647
      - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
      - BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
  custombedrockagentconstruct406BedrockCustomResourceABC131E8:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - custombedrockagentconstruct406BedrockCustomResourceProviderframeworkonEvent38B28A5F
          - Arn
    DependsOn:
      - BedrockIamConstruct406BedrockAgentBedrockModelPolicy1E0F0354
      - BedrockIamConstruct406BedrockAgentLambdaPolicy57174647
      - BedrockIamConstruct406BedrockAgentRoleA87DEEA4
      - BedrockIamConstruct406BedrockAgentS3BucketPolicyD522EAFC
      - LambdaAgentConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6863A5C62D
      - LambdaAgentConstruct406BedrockAgentLambda62EB6542
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambdaInvokeu1TDdDMoLpes23omAp0kUXOcNSkFsO0n9KPkoXL6827BCE499
      - LambdaInvokeCreateKbLambdaConstruct406BedrockAgentLambda8011C309
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:DeleteRetentionPolicy
              - logs:PutRetentionPolicy
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB
      Roles:
        - Ref: LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB
  LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A:
    Type: AWS::Lambda::Function
    Properties:
      Handler: log-retention/index.handler
      Runtime: nodejs16.x
      Code:
        S3Bucket:
          Ref: S3BucketNameWithAssets
        S3Key: assets/custom-resources/log-retention.zip
      Role:
        Fn::GetAtt:
          - LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB
          - Arn
    DependsOn:
      - LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB
      - LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB
    Metadata:
      aws:asset:path: asset.5fa1330271b8967d9254ba2d4a07144f8acefe8b77e6d6bba38261373a50d5f8
      aws:asset:is-bundled: false
      aws:asset:property: Code
Outputs:
  S3BucketNameForNewAgentArtifacts:
    Value:
      Ref: agent406artifactsBucket26949708
  S3BucketNameForKnowledgeBaseDataSource:
    Value:
      Ref: agent406knowledgebaseBucketEC2EE27E

